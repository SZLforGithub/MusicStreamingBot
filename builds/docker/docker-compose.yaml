version: '2.2'

services: 
    music_streaming_bot:
        image: music_streaming_bot
        build: 
            context: ${PARENT_DIR}
            dockerfile: builds/docker/music_streaming_bot-Dockerfile
        environment: 
            NODE_ENV: production
        command: "npm run start"
        volumes:
            - ${PARENT_DIR}:/usr/src/app
        depends_on:
            - database

    database:
        image: postgres:13.2
        environment:
            POSTGRES_USER: ${DB_USER}
            POSTGRES_PASSWORD: ${DB_PASSWORD}
        ports:
            - 5432:5432
        volumes:
            - ${PARENT_DIR}/database/conf/initdb.d:/docker-entrypoint-initdb.d
            - ${PARENT_DIR}/database/conf/postgres.conf:/etc/postgresql/postgresql.conf
            - ${PARENT_DIR}/database/data:/var/lib/postgresql/data

    web:
        image: golang:1.16.3-alpine
        build:
            context: ${PARENT_DIR}
            dockerfile: builds/docker/web-Dockerfile
        working_dir: /go/src
        volumes:
            - ${PARENT_DIR}/web:/go/src
        ports:
            - 8080:8080
        command: "go run /go/src/main.go"
